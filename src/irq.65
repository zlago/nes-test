.include "nes.i" ; hardware definitions

.segment "CODE"
; interrupt
IRQ:
.export IRQ
	; save registers
		pha ; a
		txa
		pha ; x
		tya
		pha ; y
	; check if this is a BRK (crash)
		tsx ; load s into x
		lda $104,x ; then read the 4th pushed value (flags)
		and #FLAGF_B
		bne Crash ; if B is set, this is a BRK - crash occured!
	; run IRQ stuff
		lda #CHNF_SQ1 | CHNF_SQ2 | CHNF_TRI | CHNF_NOISE
		sta SND_CHN
	; restore registers
		pla ; y
		tay
		pla ; x
		tax
		pla ; a
	; done, return
	rti

Crash:
	jmp Crash